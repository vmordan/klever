{% extends 'base.html' %}
{% comment "License" %}
% Copyright (c) 2018 ISP RAS (http://www.ispras.ru)
% Ivannikov Institute for System Programming of the Russian Academy of Sciences
%
% Licensed under the Apache License, Version 2.0 (the "License");
% you may not use this file except in compliance with the License.
% You may obtain a copy of the License at
%
%    http://www.apache.org/licenses/LICENSE-2.0
%
% Unless required by applicable law or agreed to in writing, software
% distributed under the License is distributed on an "AS IS" BASIS,
% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
% See the License for the specific language governing permissions and
% limitations under the License.
{% endcomment %}

{% load i18n %}
{% load staticfiles %}

{% block title %}{% trans 'Job reports comparison' %}{% endblock %}

{% block head_block %}
    <script src="{% static 'reports/js/comparison_2_reports.js' %}"></script>
{% endblock %}

{% block body_block %}


{% trans "Safes" as safes_trans %}
{% trans "Unsafes" as unsafes_trans %}
{% trans "Unsafe-incompletes" as unsafe_incompletes_trans %}
{% trans "Unknowns" as unknowns_trans %}
{% trans "Error trace clusters" as error_trace_clusters_trans %}
{% trans "Applied marks" as am_trans %}
{% trans "Automatic marks application" as ama_trans %}


<div class="ui accordion styled fluid">
    <div class="title right aligned"><div class="black-link">
        <i class="cogs icon"></i><i>{% trans 'Settings' %}</i>
    </div></div>

    <div class="content">
        <div class="ui horizontal segments">
            <div class="ui segment purple">
                <div align="center">{% trans 'Compare by attributes' %}</div>
                <div class="ui ordered list">
                    {% for attr, compare in data.common_attrs %}
                    <div class="item">
                        <div class="ui checkbox">
                            <input type="checkbox" id="cs1__{{ attr }}" {% if compare %} checked {% endif %}>
                            <label>
                                {{attr}}
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="ui segment purple">
                <div align="center">{% trans 'Select attributes values' %}</div>
                <div class="ui ordered list">
                {% for name, vals in data.common_attrs_vals %}
                    <div class="item">
                        <div class="black-link" onclick="toggle_by_id('settings_2_{{name}}')" style="cursor:pointer;">
                            {{ name }}: {{ vals|length }}
                            {% if vals|length == 1 %} {% trans 'element' %} {% else %} {% trans 'elements' %} {% endif %}
                        </div>
                        <ul id="settings_2_{{name}}" hidden style="list-style-type:none;">
                            {% for val in vals %}
                            <li class="item">
                                <div class="ui checkbox">
                                    <input type="checkbox" id="cs2__{{ name }}<::>{{ val }}"
                                           {% if name not in data.filtered_values or val not in data.filtered_values|get:name %} checked {% endif %}>
                                    <label>{{ val }}</label>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endfor %}
                </div>
            </div>
            <div class="ui segment purple">
                <div align="center">{% trans 'Show the same transitions' %}</div>
                <div class="ui bulleted list">
                    <div class="item">
                        <div class="ui checkbox">
                            <input type="checkbox" id="cs3__safes" {% if data.show_same_transitions|get:'safes' %} checked {% endif %}>
                            <label>{{safes_trans}}
                            </label>
                        </div>
                    </div>
                    <div class="item">
                        <div class="ui checkbox">
                            <input type="checkbox" id="cs3__unsafes" {% if data.show_same_transitions|get:'unsafes' %} checked {% endif %}>
                            <label>{{unsafes_trans}}</label>
                        </div>
                    </div>
                    <div class="item">
                        <div class="ui checkbox">
                            <input type="checkbox" id="cs3__unsafe_incompletes" {% if data.show_same_transitions|get:'unsafe_incompletes' %} checked {% endif %}>
                            <label>{{unsafe_incompletes_trans}}</label>
                        </div>
                    </div>
                    <div class="item">
                        <div class="ui checkbox">
                            <input type="checkbox" id="cs3__unknowns" {% if data.show_same_transitions|get:'unknowns' %} checked {% endif %}>
                            <label>{{unknowns_trans}}</label>
                        </div>
                    </div>
                </div>
                <div align="center">{% trans 'Show reports without common attributes' %}</div>
                <div class="ui bulleted list">
                    <div class="item">
                        <div class="ui checkbox">
                            <input type="checkbox" id="cs4__safe" {% if data.show_lost_transitions|get:'safe' %} checked {% endif %}>
                            <label>{{safes_trans}}
                            </label>
                        </div>
                    </div>
                    <div class="item">
                        <div class="ui checkbox">
                            <input type="checkbox" id="cs4__unsafe" {% if data.show_lost_transitions|get:'unsafe' %} checked {% endif %}>
                            <label>{{unsafes_trans}}</label>
                        </div>
                    </div>
                    <div class="item">
                        <div class="ui checkbox">
                            <input type="checkbox" id="cs4__unknown" {% if data.show_lost_transitions|get:'unknown' %} checked {% endif %}>
                            <label>{{unknowns_trans}}</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="ui segment purple">
                <div align="center">{% trans 'Error trace clustering' %}</div>
                <div class="ui toggle checkbox" onclick="toggle_by_id('settings_clustering')">
                    <input type="checkbox" id="cs5__auto_cluster_traces" {% if data.enable_clustering %} checked {% endif %}>
                    <label for="cs5__auto_cluster_traces">
                        {% trans 'Apply automatic clustering of error traces without marks' %}<br>
                        <span style="color:red"><b>{% trans 'Warning' %}: {% trans 'this operation *will* require a lot of time' %}</b></span>
                    </label>
                </div>

                <div id="settings_clustering" class="ui basic segment" {% if not data.enable_clustering %} hidden {% endif %}>
                    <h4 class="header ui">{% trans 'Error traces conversion function' %}</h4>
                    <select id="cs5__conversion_function">
                        {% for f in data.conversion_functions %}
                            <option value="{{ f.name }}" {% if f.name == data.conversion_function %} selected{% endif %}>{{ f.name }}</option>
                        {% endfor %}
                    </select>

                    <h4 class="header ui">{% trans 'Error traces comparison function' %}</h4>
                    <select id="cs5__comparison_function">
                        {% for f in data.comparison_functions %}
                            <option value="{{ f.name }}" {% if f.name == data.comparison_function %} selected{% endif %}>{{ f.name }}</option>
                        {% endfor %}
                    </select>

                    <h4 class="header ui">
                        {% trans 'Similarity threshold' %} ({% trans 'in percents' %}, 1% &le; threshold &le; 100%)
                        <i class="question icon red" title="{% trans 'Jaccard index of threads sets' %}"></i>
                    </h4>
                    <div class="form">
                        <input type="number" id="cs5__similarity_threshold" min="1" max="100" value="{{ data.similarity }}">
                    </div>

                    <h4 class="header ui"> {% trans 'Show results for' %}:</h4>
                    <div class="ui bulleted list">
                        <div class="item">
                            <div class="ui radio checkbox">
                                <input type="radio" id="cs5__show_diff_clusters" name="cs5__show" {% if data.clustering_type == 'diff_clusters' %} checked {% endif %}>
                                <label>{% trans 'Different clusters' %}</label>
                            </div>
                        </div>
                        <div class="item">
                            <div class="ui radio checkbox">
                                <input type="radio" id="cs5__show_diff_traces" name="cs5__show" {% if data.clustering_type == 'diff_traces' %} checked {% endif %}>
                                <label>{% trans 'Clusters with different number of error traces' %}</label>
                            </div>
                        </div>
                        <div class="item">
                            <div class="ui radio checkbox">
                                <input type="radio" id="cs5__show_all" name="cs5__show" {% if data.clustering_type == 'all' %} checked {% endif %}>
                                <label>{% trans 'All clusters' %}</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button id="apply_new_settings" class="ui tiny red button basic"><b><i class="ui icon crosshairs"></i>{% trans 'Apply' %}</b></button>
        {% if data.is_modified %}
        <button id="cancel_settings" class="ui tiny red button basic">{% trans 'Cancel' %}</button>
        {% endif %}
    </div>
</div>

<table class="ui selectable compact table celled striped">
    <thead>
        <tr bgcolor="#d3d3d3">
            <td colspan="{{data.comparison|length}}">
                <div class="ui grid">
                    <div class="one wide column" style="padding-bottom: 0px;padding-top: 9px">
                        {% if data.job_ids %}
                        <select onchange="change_id_1(this.value)" style="width:100%">
                        {% for job_id, job_name in data.job_ids %}
                            <option title="{{job_name}}" value="{{job_id}}" {% if data.comparison.0.job.id == job_id %} selected {% endif %}>{{job_name}}</option>
                        {% endfor %}
                        </select>
                        {% endif %}
                    </div>
                    {% for cmp in data.comparison %}
                    <div class="six wide column center floated center aligned">
                        <input id="job_id_{{forloop.counter}}" value="{{cmp.job.pk}}" hidden>
                        <div class="ui center aligned" style="text-align: center">
                            <b><a class="black-link" href="{% url 'jobs:job' cmp.job.pk %}">{{ cmp.job.name }}</a></b>
                        </div>
                    </div>
                    {% if forloop.counter == 1 %}
                    <div class="two wide column center floated center aligned">
                        <div id="exchange"><b style="cursor:pointer" class="center aligned black-link"><i class="exchange icon"></i></b></div>
                    </div>
                    {% endif %}
                    {% endfor %}
                    <div class="one wide column right floated right aligned" style="padding-bottom: 0px;padding-top:9px">
                        {% if data.job_ids %}
                        <select onchange="change_id_2(this.value)" style="width:100%">
                        {% for job_id, job_name in data.job_ids %}
                            <option title="{{job_name}}" value="{{job_id}}" {% if data.comparison.1.job.id == job_id %} selected {% endif %}>{{job_name}}</option>
                        {% endfor %}
                        </select>
                        {% endif %}
                    </div>

                </div>

            </td>
        </tr>

    </thead>
    <tbody>
        <tr>
            {% for cmp in data.comparison %}
            <td width="50%" class="center aligned"><b>{{ cmp.job.change_date }}</b></td>
            {% endfor %}
        </tr>
        <tr style="vertical-align: top">
            <td colspan="2">
            {% for cmp in data.comparison|slice:"1:"  %}
                <div class="ui accordion">
                    <div class="title center aligned"><div class="black-link"><b>
                        {% trans 'Number of launches' %}: {{data.comparison.0.launches}} -> {{cmp.launches}} ({% trans 'compared elements by attributes' %} {{data.comparison.0.elems_by_attrs}} ->  {{cmp.elems_by_attrs}})
                    </b></div></div>
                    <div class="content">
                        <h5 class="center aligned header"><i>{% trans 'Attributes' %}</i></h5>
                        <table class="ui selectable compact table celled striped">
                            <tbody>
                            {% for name, compare in data.joint_attrs %}
                                <tr style="vertical-align: top">
                                    <td width="25%" style="text-align: right;">
                                        {% include 'reports/comparison/attrs.html' with attrs_vals=data.comparison.0.attrs_vals attrs=data.comparison.0.attrs id=0 %}
                                    </td>
                                    <td style="text-align: center; {% if compare == 1 %}font-weight: bold {% endif %}">
                                        {{name}}
                                    </td>
                                    <td width="25%" style="text-align: left">
                                        {% include 'reports/comparison/attrs.html' with attrs_vals=cmp.attrs_vals attrs=cmp.attrs id=1 %}
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>

                        <div class="accordion">
                            <div class="center aligned title"><i><b>
                                {% trans 'Failures before verifier' %}: {{data.comparison.0.other_components_unknowns|length}} -> {{cmp.other_components_unknowns|length}}
                            </b></i></div>
                            <div class="content">
                                <table class="ui selectable compact table celled striped">
                                    <tbody>
                                        <tr>
                                            <td width="50%" style="text-align: center;">
                                                <div class="ui list">
                                                    {% for unk in data.comparison.0.other_components_unknowns %}
                                                    <div class="item">
                                                        <a class="black-link" href="{% url 'reports:unknown' unk.id %}">
                                                            {{unk.component}} {%if unk.problem%}({{unk.problem}}){% endif %}
                                                        </a>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </td>
                                            <td width="50%" style="text-align: center">
                                                <div class="ui list">
                                                    {% for unk in cmp.other_components_unknowns %}
                                                    <div class="item">
                                                        <a class="black-link" href="{% url 'reports:unknown' unk.id %}">
                                                            {{unk.component}} {%if unk.problem%}({{unk.problem}}){% endif %}
                                                        </a>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <h5 class="center aligned header"><i>{% trans 'Missing results due to different attributes' %}</i></h5>
                        <table class="ui selectable compact table celled striped">
                            <tbody>
                                <tr>
                                    {% include 'reports/comparison/transitions_lost.html' with lost_transitions_1=data.comparison.0.lost|get:'safe' lost_transitions_2=cmp.lost|get:'safe' verdict_trans=safes_trans lost_url='reports:safe' %}
                                </tr>
                                <tr>
                                    {% include 'reports/comparison/transitions_lost.html' with lost_transitions_1=data.comparison.0.lost|get:'unsafe' lost_transitions_2=cmp.lost|get:'unsafe' verdict_trans=unsafes_trans lost_url='reports:unsafe' %}
                                </tr>
                                <tr>
                                    {% include 'reports/comparison/transitions_lost.html' with lost_transitions_1=data.comparison.0.lost|get:'unknown' lost_transitions_2=cmp.lost|get:'unknown' verdict_trans=unknowns_trans lost_url='reports:unknown' %}
                                </tr>
                            </tbody>
                        </table>

                    </div>
                </div>
            {% endfor %}
            </td>
        </tr>

        <tr style="vertical-align: top">
            <td colspan="2">
            {% for cmp in data.comparison|slice:"1:" %}
                <div class="ui accordion" id="acc_row_res_{{cmp.job.id}}">
                    <div class="title center aligned"><div class="black-link"><b>
                        {% trans 'CPU time' %}: {{data.comparison.0.compared_cpu}} -> {{cmp.compared_cpu}} ({% trans 'speedup' %}:
                        <span style="{% if cmp.speedup >= 1 %} color:green {% else %} color:red {% endif %}">{{cmp.speedup}}</span>)
                    </b></div></div>
                    <div class="content">
                        <div class="ui list">
                            <div class="item center aligned">{% trans 'Full launch CPU time' %}: {{data.comparison.0.overall_cpu}} -> {{cmp.overall_cpu}}</div>
                            <div class="item center aligned">{% trans 'Full launch wall time' %}: {{data.comparison.0.overall_wall}} -> {{cmp.overall_wall}}</div>
                            <div class="item center aligned">{% trans 'Full launch memory usage' %}: {{data.comparison.0.overall_mem}} -> {{cmp.overall_mem}}</div>
                        </div>
                    </div>
                </div>
            {% endfor %}
            </td>
        </tr>

        <tr>
            {% for cmp in data.comparison|slice:"1:" %}
                <td {% if forloop.counter == 1 %} colspan="2" {% endif %}>
                    {% include 'reports/comparison/transitions.html' with cmp=cmp old_reports=data.comparison.0.safes_len cur_reports=cmp.safes_len lost_reports=cmp.safes_lost new_reports=cmp.safes_new type_trans=safes_trans type='safe' url_report='reports:safe' to_safes=cmp.safes_safes to_unsafes=cmp.safes_unsafes to_unsafe_incompletes=cmp.safes_unsafe_incompletes to_unknowns=cmp.safes_unknowns %}
                </td>
            {% endfor %}
        </tr>
        <tr>
            {% for cmp in data.comparison|slice:"1:" %}
                <td {% if forloop.counter == 1 %} colspan="2" {% endif %}>
                    {% include 'reports/comparison/transitions.html' with cmp=cmp old_reports=data.comparison.0.unsafes_len cur_reports=cmp.unsafes_len lost_reports=cmp.unsafes_lost new_reports=cmp.unsafes_new type_trans=unsafes_trans type='unsafe' url_report='reports:unsafe' to_safes=cmp.unsafes_safes to_unsafes=cmp.unsafes_unsafes to_unsafe_incompletes=cmp.unsafes_unsafe_incompletes to_unknowns=cmp.unsafes_unknowns %}
                </td>
            {% endfor %}
        </tr>
        <tr>
            {% for cmp in data.comparison|slice:"1:" %}
                <td {% if forloop.counter == 1 %} colspan="2" {% endif %}>
                    {% include 'reports/comparison/transitions.html' with cmp=cmp old_reports=data.comparison.0.unsafe_incompletes_len cur_reports=cmp.unsafe_incompletes_len lost_reports=cmp.unsafe_incompletes_lost new_reports=cmp.unsafe_incompletes_new type_trans=unsafe_incompletes_trans url_report='unsafe-incomplete' to_safes=cmp.unsafe_incompletes_safes to_unsafes=cmp.unsafe_incompletes_unsafes to_unsafe_incompletes=cmp.unsafe_incompletes_unsafe_incompletes to_unknowns=cmp.unsafe_incompletes_unknowns %}
                </td>
            {% endfor %}
        </tr>
        <tr>
            {% for cmp in data.comparison|slice:"1:" %}
                <td {% if forloop.counter == 1 %} colspan="2" {% endif %}>
                    {% include 'reports/comparison/transitions.html' with cmp=cmp old_reports=data.comparison.0.unknowns_len cur_reports=cmp.unknowns_len lost_reports=cmp.unknowns_lost new_reports=cmp.unknowns_new type_trans=unknowns_trans type='unknown' url_report='reports:unknown' to_safes=cmp.unknowns_safes to_unsafes=cmp.unknowns_unsafes to_unsafe_incompletes=cmp.unknowns_unsafe_incompletes to_unknowns=cmp.unknowns_unknowns %}
                </td>
            {% endfor %}
        </tr>

        {% if data.enable_clustering %}
        <tr style="vertical-align: top">
            <td colspan="2">
                {% for cmp_new in data.comparison|slice:"1:" %}
                    <div class="ui accordion" id="acc_row_et_1">
                        <div class="title center aligned">
                            <div class="black-link"><b>
                                {% include 'reports/comparison/lost_new_text.html' with value_trans=error_trace_clusters_trans number_all_old=data.comparison.0.clusters_len number_all_new=cmp_new.clusters_len number_new=cmp_new.clusters_new number_lost=cmp_new.clusters_lost %}
                            </b></div>
                        </div>
                        <div class="content">
                            <div class="ui list">
                                <div class="item center aligned"><i>{% trans 'Statistics' %}:</i></div>
                                <div class="item center aligned">{% trans 'Error traces' %}: {{data.comparison.0.error_traces}} -> {{cmp_new.error_traces}}</div>
                                <div class="item center aligned">
                                    {% include 'reports/comparison/lost_new_text.html' with value_trans=am_trans number_all_old=data.comparison.0.cluster_marks number_all_new=cmp_new.cluster_marks number_new=cmp_new.clusters_am_new number_lost=cmp_new.clusters_am_lost %}
                                </div>
                                <div class="item center aligned">
                                    {% include 'reports/comparison/lost_new_text.html' with value_trans=ama_trans number_all_old=data.comparison.0.cluster_ama number_all_new=cmp_new.cluster_ama number_new=cmp_new.clusters_ama_new number_lost=cmp_new.clusters_ama_lost %}
                                </div>
                            </div>
                                <table class="ui selectable compact table celled striped">
                                    <thead>
                                        <tr>
                                            <td style="background: #d3d3d3" width="25%">{% trans 'Error traces' %}</td>
                                            <td style="background: #d3d3d3; text-align: center">{% trans 'Attributes' %} ({% trans 'Origin' %})</td>
                                            <td style="background: #d3d3d3" width="25%">{% trans 'Error traces' %}</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    {% for cluster in cmp_new.clusters %}
                                        {% if not cluster.hide %}
                                        <tr>
                                            <td {% if cluster.color %}style="background: {{cluster.color}}; text-align: right"{% endif %} style="text-align: right">
                                                {% if cluster.reports_0|length > 1 %}
                                                <div class="black-link" onclick="toggle_by_id('acc_et_{{forloop.parentloop.counter}}_{{forloop.counter}}_0')" style="cursor:pointer;">
                                                    {{cluster.reports_0|length}} {% trans 'error traces' %}
                                                </div>
                                                <div id="acc_et_{{forloop.parentloop.counter}}_{{forloop.counter}}_0" class="ui list" hidden>
                                                    {% for report in cluster.reports_0 %}
                                                        <div class="item">
                                                            <a  {% if cluster.color %} class="black-link" {% endif %} href="{% url 'reports:unsafe' report %}">{% trans 'trace' %}</a>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                                {% elif cluster.reports_0 %}
                                                <a {% if cluster.color %} class="black-link" {% endif %} href="{% url 'reports:unsafe' cluster.reports_0.0 %}">{% trans 'trace' %}</a>
                                                {% else %}
                                                -
                                                {% endif %}
                                            </td>
                                            <td {% if cluster.color %}style="background: {{cluster.color}}; text-align: center"{% endif %} style="text-align: center">
                                                {{cluster.attrs}}
                                                {% if cluster.mark %}
                                                   (<a {% if cluster.color %} class="black-link" {% endif %} href="{% url 'marks:mark' 'unsafe' cluster.mark %}">{% trans 'Mark' %} {{cluster.mark}}</a>)
                                                {% else %}
                                                    <span class="black-link" style="cursor:pointer;" onclick="show_converted_error_trace('{{data.conversion_function}}', '{{cluster.reports}}')">({% trans 'Auto' %})</span>
                                                {% endif %}
                                            </td>
                                            <td {% if cluster.color %}style="background: {{cluster.color}}"{% endif %}>
                                                {% if cluster.reports_1|length > 1 %}
                                                <div class="black-link" onclick="toggle_by_id('acc_et_{{forloop.parentloop.counter}}_{{forloop.counter}}_1')" style="cursor:pointer;">
                                                    {{cluster.reports_1|length}} {% trans 'error traces' %}
                                                </div>
                                                <div id="acc_et_{{forloop.parentloop.counter}}_{{forloop.counter}}_1" class="ui list" hidden>
                                                    {% for report in cluster.reports_1 %}
                                                        <div class="item">
                                                            <a {% if cluster.color %} class="black-link" {% endif %} href="{% url 'reports:unsafe' report %}">{% trans 'trace' %}</a>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                                {% elif cluster.reports_1 %}
                                                <a {% if cluster.color %} class="black-link" {% endif %} href="{% url 'reports:unsafe' cluster.reports_1.0 %}">{% trans 'trace' %}</a>
                                                {% else %}
                                                -
                                                {% endif %}
                                            </td>
                                            {% endif %}
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                        </div>
                    </div>
                {% endfor %}
            </td>
        </tr>
        {% endif %}

    </tbody>
</table>

<div id="show_converted_error_trace" class="ui dinamic modal fullscreen">
    <div class="ui header">{% trans 'Converted error trace' %}</div>
    <div class="content">
        <div class="ui form">
            <textarea readonly id="converted_error_trace" rows="30" style="font-family: monospace"></textarea>
        </div>
    </div>
    <div class="actions">
        <div class="ui grid">
            <div class="eight wide column right aligned">
                <button id="cancel_show_converted_error_trace" type="button" class="ui blue button small">{% trans 'Cancel' %}</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
